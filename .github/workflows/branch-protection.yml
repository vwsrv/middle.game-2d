name: Branch Protection Setup

on:
  workflow_dispatch:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 UTC –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    - cron: '0 2 * * *'

jobs:
  setup-branch-protection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Branch Protection
        uses: actions/github-script@v7
        with:
          script: |
            const { data: branches } = await github.rest.repos.listBranches({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const protectedBranches = ['main', 'dev'];
            
            for (const branch of protectedBranches) {
              const branchExists = branches.some(b => b.name === branch);
              
              if (branchExists) {
                try {
                  await github.rest.repos.updateBranchProtection({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    branch: branch,
                    required_status_checks: {
                      strict: true,
                      contexts: ['Lint', 'Test']
                    },
                    enforce_admins: false,
                    required_pull_request_reviews: {
                      required_approving_review_count: 2,
                      dismiss_stale_reviews: true,
                      require_code_owner_reviews: false,
                      require_last_push_approval: true
                    },
                    restrictions: null,
                    allow_force_pushes: false,
                    allow_deletions: false,
                    block_creations: false,
                    required_conversation_resolution: true
                  });
                  
                  console.log(`‚úÖ Branch protection updated for ${branch}`);
                } catch (error) {
                  console.log(`‚ùå Failed to update branch protection for ${branch}:`, error.message);
                }
              } else {
                console.log(`‚ö†Ô∏è Branch ${branch} does not exist, skipping protection setup`);
              }
            }

      - name: Create Pull Request Template
        uses: actions/github-script@v7
        with:
          script: |
            const templateContent = [
              '## –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π',
              '',
              '–û–ø–∏—à–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ —á—Ç–æ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ –≤ —ç—Ç–æ–º PR.',
              '',
              '## –¢–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏–π',
              '',
              '- [ ] üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞',
              '- [ ] ‚ú® –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å',
              '- [ ] üìù –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è',
              '- [ ] üé® –£–ª—É—á—à–µ–Ω–∏–µ UI/UX',
              '- [ ] ‚ö°Ô∏è –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å',
              '- [ ] üîß –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥',
              '- [ ] üß™ –¢–µ—Å—Ç—ã',
              '- [ ] üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏',
              '',
              '## –ß–µ–∫-–ª–∏—Å—Ç',
              '',
              '- [ ] –ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥—Å—Ç–∞–π–ª—É –ø—Ä–æ–µ–∫—Ç–∞',
              '- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã/–æ–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã',
              '- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞',
              '- [ ] –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ',
              '- [ ] –í—Å–µ CI –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ',
              '',
              '## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
              '',
              '–î–æ–±–∞–≤—å—Ç–µ –ª—é–±—É—é –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–∞ –¥–ª—è —Ä–µ–≤—å—é–µ—Ä–æ–≤.',
              '',
              '---',
              '',
              '**–°–æ–∑–¥–∞–Ω–æ —Å ‚ù§Ô∏è –∏—Å–ø–æ–ª—å–∑—É—è Feature-Sliced Design**'
            ].join('\n');

            try {
              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: '.github/pull_request_template.md',
                message: 'Add pull request template',
                content: Buffer.from(templateContent).toString('base64'),
                branch: 'main'
              });
              
              console.log('‚úÖ Pull request template created');
            } catch (error) {
              console.log('‚ùå Failed to create pull request template:', error.message);
            }

      - name: Create Issue Templates
        uses: actions/github-script@v7
        with:
          script: |
            const bugReportTemplate = [
              '---',
              'name: üêõ Bug Report',
              'about: –°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç –æ–± –æ—à–∏–±–∫–µ',
              'title: \'[BUG] \'',
              'labels: [\'bug\']',
              'assignees: \'\'',
              '---',
              '',
              '## –û–ø–∏—Å–∞–Ω–∏–µ –±–∞–≥–∞',
              '',
              '–ö—Ä–∞—Ç–∫–æ–µ –∏ —á–µ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–∞–≥–∞.',
              '',
              '## –®–∞–≥–∏ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è',
              '',
              '1. –ü–µ—Ä–µ–π—Ç–∏ –∫ \'...\'',
              '2. –ù–∞–∂–∞—Ç—å –Ω–∞ \'....\'',
              '3. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –¥–æ \'....\'',
              '4. –£–≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫—É',
              '',
              '## –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ',
              '',
              '–ö—Ä–∞—Ç–∫–æ–µ –∏ —á–µ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏.',
              '',
              '## –°–∫—Ä–∏–Ω—à–æ—Ç—ã',
              '',
              '–ï—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ, –¥–æ–±–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã.',
              '',
              '## –û–∫—Ä—É–∂–µ–Ω–∏–µ',
              '',
              ' - OS: [–Ω–∞–ø—Ä–∏–º–µ—Ä Windows 10]',
              ' - Browser: [–Ω–∞–ø—Ä–∏–º–µ—Ä chrome, safari]',
              ' - Version: [–Ω–∞–ø—Ä–∏–º–µ—Ä 22]',
              '',
              '## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
              '',
              '–î–æ–±–∞–≤—å—Ç–µ –ª—é–±—É—é –¥—Ä—É–≥—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–±–ª–µ–º–µ –∑–¥–µ—Å—å.'
            ].join('\n');

            const featureRequestTemplate = [
              '---',
              'name: ‚ú® Feature Request',
              'about: –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞',
              'title: \'[FEATURE] \'',
              'labels: [\'enhancement\']',
              'assignees: \'\'',
              '---',
              '',
              '## –ü—Ä–æ–±–ª–µ–º–∞',
              '',
              '–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ —Ä–µ—à–∏—Ç—å. –ù–∞–ø—Ä–∏–º–µ—Ä: –Ø –≤—Å–µ–≥–¥–∞ —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞—é—Å—å –∫–æ–≥–¥–∞ [...]',
              '',
              '## –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ',
              '',
              '–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–∏–∑–æ–π—Ç–∏.',
              '',
              '## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã',
              '',
              '–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ª—é–±—ã—Ö –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–ª–∏.',
              '',
              '## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
              '',
              '–î–æ–±–∞–≤—å—Ç–µ –ª—é–±—É—é –¥—Ä—É–≥—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–ª–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –æ –∑–∞–ø—Ä–æ—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–¥–µ—Å—å.'
            ].join('\n');

            const templates = [
              { name: 'bug_report.md', content: bugReportTemplate },
              { name: 'feature_request.md', content: featureRequestTemplate }
            ];

            for (const template of templates) {
              try {
                await github.rest.repos.createOrUpdateFileContents({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: `.github/ISSUE_TEMPLATE/${template.name}`,
                  message: `Add ${template.name} template`,
                  content: Buffer.from(template.content).toString('base64'),
                  branch: 'main'
                });
                
                console.log(`‚úÖ ${template.name} template created`);
              } catch (error) {
                console.log(`‚ùå Failed to create ${template.name} template:`, error.message);
              }
            } 